<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°–ø–∏—Å–æ–∫ –∫–æ–º–º—É—Ç–∞—Ç–æ—Ä–æ–≤</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { display: flex; font-family: Arial, sans-serif; margin:0;}
        .sidebar { width: 250px; height:100vh;overflow-y:auto; position:fixed;top:0;left:0;background: linear-gradient(to left, #ffffff -3%, #99ccff 90%); padding: 10px; box-sizing:border-box; flex-shrink:0; }
        .content { flex: 1; padding: 20px;margin-left:250px; }
        .switch-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #ddd; transition: background 0.2s, color 0.2s; }
        .switch-item:hover { background: #99ccff; color:#fff}
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
        th { background: #f0f0f0; }
        button { margin-top: 10px; padding: 6px 12px; }
    </style>
</head>
<body>
<div class="sidebar">
    <h3>–°–ø–∏—Å–æ–∫ –∫–æ–º–º—É—Ç–∞—Ç–æ—Ä–æ–≤</h3>
    {% for sw in switches %}
        <div class="switch-item" data-id="{{ sw.id }}">{{ sw.name }}</div>
    {% endfor %}
</div>

<div id="ports-section" class="content">
    <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–º—É—Ç–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ—Ä—Ç–æ–≤</p>
</div>
<div style="position: fixed; top: 10px; right: 20px;">
    <form method="post" action="{% url 'logout' %}">
        {% csrf_token %}
        <button type="submit" style="background: linear-gradient(to bottom, #ffffff 0%, #99ccff 100%);">–í—ã–π—Ç–∏</button>
    </form>
</div>
<script>
$(document).ready(function () {
    let hasUnsavedChanges = false;
    let isEditing = false;

    $(".switch-item").on("click", function () {
        if (hasUnsavedChanges) {
            if (!confirm("–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–±—Ä–æ—Å–∏—Ç –∏—Ö. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?")) {
                return;
            }
            hasUnsavedChanges = false;
        }

        let switchId = $(this).data("id");

        $.get(`/switch/${switchId}/`, function (data) {
            $("#ports-section").html(data);
            initEditSaveHandlers(); // –≤—ã–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ –ø–æ–¥–≥—Ä—É–∑–∫–∏ HTML
        });
    });


function initEditSaveHandlers() {
    const editBtn = $("#edit-btn");
    const saveBtn = $("#save-btn");
    const form = $("#ports-form");

    if (!editBtn.length || !saveBtn.length || !form.length) return;

    editBtn.off("click").on("click", function () {
        isEditing = !isEditing;

        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º disabled –¥–ª—è input –∏ select
        form.find("input, select").prop("disabled", !isEditing);

        editBtn.text(isEditing ? "üîí –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" : "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å");
    });

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    form.off("input change").on("input change", "input, select", function () {
        if (isEditing) {
            hasUnsavedChanges = true;
            saveBtn.prop("disabled", false);
        }
    });

    saveBtn.off("click").on("click", function () {
        let updatedData = [];

        form.find("tbody tr").each(function () {
            const portId = $(this).find("input, select").first().attr("name").match(/_(\d+)$/)[1];
            if (!portId) return;

            updatedData.push({
                id: parseInt(portId),
                connected_device: form.find(`[name="connected_device_${portId}"]`).val(),
                ip_address: form.find(`[name="ip_address_${portId}"]`).val(),
                device_name: form.find(`[name="device_name_${portId}"]`).val(),
                portType: form.find(`[name="portType_${portId}"]`).val(),
                status: form.find(`[name="status_${portId}"]`).val(),
                vlanNum: form.find(`[name="vlanNum_${portId}"]`).val(),
                upLink: form.find(`[name="upLink_${portId}"]`).val(),
                addInfo: form.find(`[name="addInfo_${portId}"]`).val(),
                cabPlacement: form.find(`[name="cabPlacement_${portId}"]`).val()
            });
        });

        fetch("{% url 'update_ports' %}", {
            method: "POST",
            body: JSON.stringify(updatedData),
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            }
        }).then(response => {
            if (response.ok) {
                alert("–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
                hasUnsavedChanges = false;
                saveBtn.prop("disabled", true);
                isEditing = false;
                form.find("input, select:not(#port-filter)").prop("disabled", true);
                editBtn.text("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å");
            } else {
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö");
            }
        });
    });
  const tbody = form.find("tbody");
  tbody.find("tr").each(function(i){ $(this).attr("data-index", i); });

  // --- –•–µ–ª–ø–µ—Ä—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
  function isUsed(row) {
    const device = $(row).find('input[name^="connected_device"]').val() || "";
    return device.trim().length > 0;
  }

  function statusIsOff(row) {
    const sel = $(row).find('select[name^="status"]');
    const val = (sel.val() || "").toString().toLowerCase();
    const txt = (sel.find("option:selected").text() || "").toLowerCase();

    // –ü—ã—Ç–∞–µ–º—Å—è —É–≥–∞–¥–∞—Ç—å –ø–æ value –ò/–ò–õ–ò –ø–æ —Ä—É—Å—Å–∫–æ–º—É —Ç–µ–∫—Å—Ç—É "–≤—ã–∫–ª—é—á–µ–Ω–æ"
    const knownOffValues = ["off","0","false","disabled","down"];
    return knownOffValues.includes(val) || txt.includes("–≤—ã–∫–ª—é—á");
  }

  function isFree(row) {
    return !isUsed(row) && statusIsOff(row);
  }

  function applyFilter(mode) {
    const rows = tbody.find("tr").get();

    if (mode === "free") {
      rows.sort((a,b) => (isFree(b) - isFree(a)));
    } else if (mode === "used") {
      rows.sort((a,b) => (isUsed(b) - isUsed(a)));
    } else {
      // "all" ‚Äî –≤–µ—Ä–Ω—É—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
      rows.sort((a,b) => {
        return parseInt($(a).attr("data-index")) - parseInt($(b).attr("data-index"));
      });
    }

    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
    $.each(rows, function(_, row){ tbody.append(row); });
  }

  // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ —Ñ–∏–ª—å—Ç—Ä–∞
  $("#port-filter").off("change").on("change", function () {
    applyFilter($(this).val());
  });

}
});
</script>

</body>
</html>
